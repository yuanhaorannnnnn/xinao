<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Twin Viewer</title>
    <link rel="stylesheet" href="./src/css/style.css">
    <!-- Three.js 核心库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls 插件 -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/controls/OrbitControls.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- ECharts CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.2/echarts.min.js"></script>

    <!-- Tabulator CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.4.3/css/tabulator.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.4.3/js/tabulator.min.js"></script>
</head>
<body>
    <div id="loading">Loading initial data...</div>
    <div id="control-panel">
        <div class="field-selector">
            <h3>物理场选择</h3>
            <button id="btn-temperature">温度场</button>
            <button id="btn-displacement">位移</button>
            <button id="btn-vonmises_stress">冯米塞斯应力</button>
            <button id="btn-displace_vector_x">位移_x</button>
            <button id="btn-displace_vector_y">位移_y</button>
            <button id="btn-displace_vector_z">位移_z</button>
        </div>
    </div>
    <!-- 在index.html中添加 -->
    <div id="analytics-panel" class="panel">
        <h3>数据分析</h3>
        <div id="stats-table"></div>
        <div id="histogram-chart" style="height: 300px;"></div>
        <div id="scatter-plot" style="height: 300px;"></div>
    </div>

    <script type="module">
        // 导入模块
        import { DataLoader } from './src/js/loader.js';
        import { PointCloudRenderer } from './src/js/renderer.js';
        import { ColorMapper } from './src/js/colorMapper.js';
        import { AnalyticsPanel } from './src/js/analytics.js';

        // 全局访问CDN库
        const echarts = window.echarts;
        const Tabulator = window.Tabulator

        const analyticsPanel = new AnalyticsPanel();

        // 初始化 Three.js 场景
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 添加基础光照
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);

        // 添加坐标系辅助
        const axesHelper = new THREE.AxesHelper(10);
        scene.add(axesHelper);

        // 初始化组件
        const loader = new DataLoader();
        const pointCloudRenderer = new PointCloudRenderer(scene);

        // 全局状态
        let currentPositions = null;

        // 初始化场景
        async function initScene() {
            try {
                console.log('Loading mesh data...');
                currentPositions = await loader.loadAllChunks('mesh');
                
                // 初始渲染白色点云
                const initialColors = new Float32Array(currentPositions.length).fill(1);
                pointCloudRenderer.updateGeometry(currentPositions, initialColors);
                
                // 相机设置
                camera.position.z = 50;
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;

                // 绑定事件监听器
                document.getElementById('btn-temperature').addEventListener('click', () => loadField('temperature'));
                document.getElementById('btn-displacement').addEventListener('click', () => loadField('displacement'));
                document.getElementById('btn-vonmises_stress').addEventListener('click', () => loadField('vonmises_stress'));
                document.getElementById('btn-displace_vector_x').addEventListener('click', () => loadField('displace_vector_x'));
                document.getElementById('btn-displace_vector_y').addEventListener('click', () => loadField('displace_vector_y'));
                document.getElementById('btn-displace_vector_z').addEventListener('click', () => loadField('displace_vector_z'));

                console.log('Initialization complete');
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Initialization failed:', error);
                document.getElementById('loading').textContent = '初始化失败，请检查控制台';
            }
        }

        // 物理场可视化函数
        async function updateFieldVisualization(fieldName) {
            try {
                const fieldData = await loader.loadFieldData(fieldName);
                const metadata = await loader.loadMetadata('field', fieldName);
                
                // 计算颜色映射
                const colors = ColorMapper.mapValues(
                    fieldData, 
                    metadata.min, 
                    metadata.max
                );
                
                // 更新几何体
                pointCloudRenderer.updateGeometry(currentPositions, colors);
                analyticsPanel.update(fieldData, metadata);
            } catch (error) {
                console.error('Field update failed:', error);
            }
        }

        // 暴露全局函数
        window.loadField = async (fieldName) => {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = `正在加载 ${fieldName}...`;
            console.log('loading chunk data', fieldName);
            await updateFieldVisualization(fieldName);
            document.getElementById('loading').style.display = 'none';
        };

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // 启动初始化
        initScene();
        animate();
    </script>
</body>
</html>